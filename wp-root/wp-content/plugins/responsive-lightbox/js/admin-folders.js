(e=>{let r=0,t=null,l=null,s="",o=!1,a=!1,d=null,n=2,i={};const c=()=>{const r=wp.media.view.MediaFrame.Post;wp.media.view.MediaFrame.Post=r.extend({initialize(...e){r.prototype.initialize.apply(this,e),this.on("content:render",this.contentRender,this)},contentRender(r){if(null!==r){const t=r.toolbar.secondary.$el.find("select.attachment-filters");if(t.length>2){const r=parseInt(100/t.length)-2;e(t).each((t,l)=>{e(l).css("width",`calc(${r}% - 12px)`)})}}}});const t=wp.media.view.AttachmentFilters.extend({id:"media-attachment-rl-folders-filters",className:"attachment-filters attachment-rl-folders-filter",change(...e){wp.media.view.AttachmentFilters.prototype.change.apply(this,e),null!==l&&l.controller.states.get("library").get("library").observe(wp.Uploader.queue)},createFilters(){const r={};let t=0;const l={text:rlFoldersArgs.root,priority:1,props:{[rlFoldersArgs.taxonomy]:0,force_update:0,include_children:!1}};if(""!==rlFoldersArgs.terms){const s=e(e.parseHTML(rlFoldersArgs.terms)).find("option");s.length>0&&(r[0]=l,s.each((l,s)=>{t=parseInt(e(s).val()||0),t=0===t?"all":t,n=l+2;const o=e(s).html();e(s).text(o),r[t]={text:e(s).text(),priority:n,props:{[rlFoldersArgs.taxonomy]:t,force_update:0,include_children:!1}}}))}else r.all={text:rlFoldersArgs.all_terms,priority:1,props:{[rlFoldersArgs.taxonomy]:"all",force_update:0,include_children:!0}},r[0]=l;this.filters=r}}),s=wp.media.view.AttachmentsBrowser;wp.media.view.AttachmentsBrowser=wp.media.view.AttachmentsBrowser.extend({createToolbar(){s.prototype.createToolbar.call(this),d=this,"rl-remote-library"!==this.model.get("id")&&(this.toolbar.set("RLfoldersFilterLabel",new wp.media.view.Label({value:"Filter by folder",attributes:{for:"media-attachment-rl-folders-filters"},priority:-75}).render()),this.toolbar.set("RLfoldersAttachmentFilters",new t({controller:this.controller,model:this.collection.props,priority:-75}).render()))}});const o=wp.media.view.AttachmentCompat;wp.media.view.AttachmentCompat=wp.media.view.AttachmentCompat.extend({initialize(){o.prototype.initialize.call(this);const r=this.model.saveCompat;this.model.saveCompat=(t,l)=>{const s=e(".rl-media-tag-select2"),o=s.select2("data"),a=[];for(let e=0;e<o.length;e++)a.push(o[e].id);return t[s.attr("name")]=a.join(","),r.call(this.model,t,l)}},render(){o.prototype.render.call(this),e(".select2-container--open").remove(),setTimeout(f,5)},save(r){e(r.target).hasClass("select2-search__field")||o.prototype.save.call(this,r)}})};e(()=>{if(void 0!==wp.Uploader?e.extend(wp.Uploader.prototype,{init(){this.uploader.bind("BeforeUpload",e=>{e.settings.multipart_params.rl_folders_upload_files_term_id=r})}}):"undefined"!=typeof uploader&&uploader.bind("BeforeUpload",e=>{uploader.settings.multipart_params.rl_folders_upload_files_term_id=r}),"media"===rlFoldersArgs.page)c(),e(document).on("change","#media-attachment-rl-folders-filters",r=>{e("#rl_folders_upload_files").val(e(r.currentTarget).val())});else{const d=[],n=["sort","dnd"];s=e("body").hasClass("rl-folders-upload-grid-mode")?"grid":"list","list"===s?(e("#posts-filter").before(rlFoldersArgs.template),e(".filter-items .actions").append('<span class="spinner"></span>'),g("list")):(e("#wp-media-grid").append(rlFoldersArgs.template),c()),rlFoldersArgs.wholerow&&n.push("wholerow"),e("#rl-folders-tree").jstree({core:{check_callback:(e,r,t,l,s)=>!("move_node"===e&&"#"===t.parent&&"all"===t.a_attr["data-term_id"]),multiple:!1,expand_selected_onload:!1,worker:!1,animation:150},dnd:{is_draggable:e=>"#"!==e[0].parent},sort(e,r){return"j1_1"===e?-1:this.get_text(e).toLowerCase()>this.get_text(r).toLowerCase()?1:-1},plugins:n}),e("#rl-folders-tree").jstree("set_theme",rlFoldersArgs.theme),e(document).on("click",".jstree-anchor",y),e(document).on("click",".rl-folders-add-new-folder",()=>{const r=e("#rl-folders-tree").jstree().get_selected().toString(),t=e("#rl-folders-tree").jstree("create_node",r,rlFoldersArgs.new_folder,"inside",()=>{},!0);return e("#rl-folders-tree").jstree("deselect_node",r),"list"===s&&(a=!0),e("#rl-folders-tree").jstree("select_node",t,!0,!0),e("#rl-folders-tree").jstree("select_node",t,!0,!0),e("#rl-folders-tree").jstree("open_node",r,()=>{const l=e(`#${t}_anchor`),s=l.html().match("<i(?:.+)?/i>")[0],o=e("#rl-folders-tree").jstree(!0).get_json("#",{flat:!0});e(document).off("click",".jstree-anchor"),e.each(o,(r,t)=>{0==t.state.selected&&e("#rl-folders-tree").jstree("disable_node",t.id)}),e(".rl-folders-add-new-folder").hide(),e(".rl-folders-save-new-folder, .rl-folders-cancel-new-folder").show(),e(".rl-folders-rename-folder, .rl-folders-delete-folder, .rl-folders-expand-folder, .rl-folders-collapse-folder").addClass("disabled-link"),l.hide().after(`<span id="${r}_span">${s}<input id="rl-folders-enter-new-folder" type="text" value="${rlFoldersArgs.new_folder}" placeholder="" data-term_id="${parseInt(l.data("term_id"))}" data-nof="0" /></span>`),e("#rl-folders-enter-new-folder").trigger("select"),e("#rl-folders-enter-new-folder").on("keyup",t=>{13===t.which?j(!0,parseInt(e(`#${r}_anchor`).data("term_id"))):27===t.which&&v(!0,!0)})},e("#rl-folders-tree").jstree().settings.core.animation),!1}),e(document).on("click",".rl-folders-rename-folder",()=>{const r=e("#rl-folders-tree").jstree().get_selected().toString(),t=e(`#${r}_anchor`),l=t.data("term_id");if("all"===l||0===l)return!1;const s=t.html().match("(<i(?:.+)?/i>)(.+)"),o=s[2].split(" "),a=o.pop().match(/\d+/)[0],d=o.join(" "),n=e("#rl-folders-tree").jstree(!0).get_json("#",{flat:!0});e(document).off("click",".jstree-anchor"),e.each(n,(r,t)=>{0==t.state.selected&&e("#rl-folders-tree").jstree("disable_node",t.id)}),e(".rl-folders-rename-folder").hide(),e(".rl-folders-save-folder, .rl-folders-cancel-folder").show(),e(".rl-folders-add-new-folder, .rl-folders-delete-folder, .rl-folders-expand-folder, .rl-folders-collapse-folder").addClass("disabled-link"),t.hide().after(`<span id="${r}_span">${s[1]}<input id="rl-folders-enter-folder" type="text" value="" placeholder="" data-term_id="${parseInt(l)}" data-nof="${a}" /></span>`);const i=e(`span#${r}_span input`);return i.val(d),i[0].placeholder=d,e("#rl-folders-enter-folder").trigger("select"),e("#rl-folders-enter-folder").on("keyup",e=>{13===e.which?j(!1,0):27===e.which&&v(!1,!1)}),!1}),e(document).on("click",".rl-folders-save-folder",()=>(j(!1,0),!1)),e(document).on("click",".rl-folders-save-new-folder",()=>(j(!0,parseInt(e(`#${e("#rl-folders-tree").jstree().get_selected().toString()}_anchor`).data("term_id"))),!1)),e(document).on("click",".rl-folders-cancel-folder",()=>(v(!1,!1),!1)),e(document).on("click",".rl-folders-cancel-new-folder",()=>(v(!0,!0),!1)),e(document).on("click",".rl-folders-delete-folder",r=>{if(!e(r.currentTarget).hasClass("disabled-link")&&confirm(rlFoldersArgs.remove_children?rlFoldersArgs.delete_terms:rlFoldersArgs.delete_term)){u(!0);const r=e("#rl-folders-tree").jstree().get_selected().toString(),t=parseInt(e(`#${r}_anchor`).data("term_id"));e.post(ajaxurl,{action:"rl-folders-delete-term",term_id:t,children:rlFoldersArgs.remove_children?1:0,nonce:rlFoldersArgs.nonce}).done(t=>{try{if(t.success){const l=e("#rl-folders-tree").jstree("get_parent",r);b(e(t.data).find("option"),""),rlFoldersArgs.remove_children||e("#rl-folders-tree").jstree("is_leaf",r)||e("#rl-folders-tree").jstree("open_node",r,()=>{e("#rl-folders-tree").jstree("get_children_dom",r).each((r,t)=>{w(e(t).attr("id"),l)})},e("#rl-folders-tree").jstree().settings.core.animation),e("#rl-folders-tree").jstree("delete_node",r),e("#rl-folders-tree").jstree("select_node",l),e("#media-attachment-rl-folders-filters").val(e(`#${l}_anchor`).data("term_id")).trigger("change"),m()}}catch(l){}u(!1)}).fail(()=>{u(!1)})}return!1}),e(document).on("click",".rl-folders-expand-folder",r=>(e(r.currentTarget).hasClass("disabled-link")||e("#rl-folders-tree").jstree("open_all",e("#rl-folders-tree").jstree().get_selected(),e("#rl-folders-tree").jstree().settings.core.animation),!1)),e(document).on("click",".rl-folders-collapse-folder",r=>(e(r.currentTarget).hasClass("disabled-link")||e("#rl-folders-tree").jstree("close_all",e("#rl-folders-tree").jstree().get_selected(),e("#rl-folders-tree").jstree().settings.core.animation),!1)),e("#rl-folders-tree").on("select_node.jstree",()=>{const t=e("#rl-folders-tree").jstree().get_selected().toString();if("list"===s)return void(a?a=!1:window.location.replace(e(`#${t}_anchor`).attr("href")));p("grid"),p("list");const l=e(`#${t}_anchor`).data("term_id");e("#rl_folders_upload_files").val("all"===l?0:l),r=parseInt(l),isNaN(r)&&(r=0),"all"===l?e(".rl-folders-add-new-folder, .rl-folders-rename-folder, .rl-folders-delete-folder").addClass("disabled-link"):0===l?(e(".rl-folders-rename-folder, .rl-folders-delete-folder").addClass("disabled-link"),e(".rl-folders-add-new-folder").removeClass("disabled-link")):e(".rl-folders-add-new-folder, .rl-folders-rename-folder, .rl-folders-delete-folder").removeClass("disabled-link"),e("#rl-folders-tree").jstree("is_leaf",t)?e(".rl-folders-expand-folder, .rl-folders-collapse-folder").addClass("disabled-link"):e(".rl-folders-expand-folder, .rl-folders-collapse-folder").removeClass("disabled-link")}),e("#rl-folders-tree").on("rename_node.jstree",(e,r)=>{i.create&&(r.node.a_attr["data-term_id"]=i.response.term_id,r.node.a_attr.href=i.response.url,i={})}),e("#rl-folders-tree").on("ready.jstree",(r,l)=>{"list"===s&&h("list"),t=new PerfectScrollbar("#rl-folders-tree",{wheelSpeed:3,wheelPropagation:!0,minScrollbarLength:30}),e.jstree.core.prototype.edit=()=>{e(".rl-folders-rename-folder").trigger("click")},p("grid"),p("list")}),e("#rl-folders-tree").on("close_all.jstree",()=>{m()}),e("#rl-folders-tree").on("open_all.jstree",()=>{m()}),e("#rl-folders-tree").on("close_node.jstree",()=>{m()}),e("#rl-folders-tree").on("open_node.jstree",()=>{m(),"grid"===s&&h("grid")}),e(document).on("ajaxComplete",(e,t,o)=>{const a=x("action",o.data);"rl-folders-move-attachments"===a?h(s):"query-attachments"===a&&(h("grid"),g("grid"),null===l&&(l=wp.media.frame.content.get(),r=0))}),e(document).on("change","#media-attachment-rl-folders-filters",r=>{if("list"===s)return;const t=e("#rl-folders-tree").jstree().get_selected().toString();if(void 0===d[t])d[t]=!0;else{const t=e(r.currentTarget).val();l.collection.props.set("force_update",+new Date),e(r.currentTarget).val(t)}}),e("#rl-folders-tree").on("move_node.jstree",(r,t)=>{if(o)return o=!1,!1;u(!0),e.post(ajaxurl,{action:"rl-folders-move-term",term_id:parseInt(t.node.a_attr["data-term_id"]),parent_id:parseInt(e(`#${t.parent}_anchor`).data("term_id")),nonce:rlFoldersArgs.nonce}).done(r=>{try{r.success?(b(e(r.data).find("option"),""),e("#rl-folders-tree").jstree("open_node",t.parent,"",e("#rl-folders-tree").jstree().settings.core.animation)):w(t.node.id,t.old_parent,t.old_position)}catch(l){w(t.node.id,t.old_parent,t.old_position)}u(!1)}).fail(()=>{w(t.node.id,t.old_parent,t.old_position),u(!1)})}),e(document).on("click",".select-mode-toggle-button",()=>{l.controller.isModeActive("select")?g("grid"):e("#media-attachment-rl-folders-filters").hide()})}e(document).on("change","#rl_folders_upload_files",t=>{r=parseInt(e(t.currentTarget).val()),isNaN(r)&&(r=0)}),"media"!==rlFoldersArgs.page&&e(document).on("keydown",r=>{("INPUT"!==r.target.nodeName&&"TEXTAREA"!==r.target.nodeName||r.target.readOnly||r.target.disabled)&&27===r.keyCode&&e(".media-modal-close").trigger("click")})});const f=()=>{const r=e(".rl-media-tag-select2");0===r.length||r.hasClass("select2-hidden-accessible")||(e("div.attachment-info").off("scroll"),e("div.media-sidebar").off("scroll"),r.select2({closeOnSelect:!0,scrollAfterSelect:!1,allowClear:!1,debug:!1,multiple:!0,width:"100%",minimumInputLength:2,dropdownCssClass:"rl-media-tag-select2-dropdown",ajax:{delay:200,url:ajaxurl,data:e=>({action:"ajax-tag-search",tax:"rl_media_tag",q:e.term}),processResults:e=>{const r=[];e=e.split(/[\r\n]+/).filter(Boolean);for(let t=0;t<e.length;t++)r[t]={id:e[t],text:e[t]};return{results:r}}}}))},p=r=>{const t=e(`.view-switch > a.view-${r}`),l=t.prop("href"),s=l.split("upload.php")[1],o=x(rlFoldersArgs.taxonomy,s);let a=e(`#${e("#rl-folders-tree").jstree().get_selected().toString()}_anchor`).data("term_id");"list"===r&&("all"===a?a=0:0===a&&(a=-1)),""===o?t.prop("href",`${l}&${rlFoldersArgs.taxonomy}=${a}`):t.prop("href",l.replace(new RegExp(`${rlFoldersArgs.taxonomy}=(-?[0-9]+|all)`,"g"),`${rlFoldersArgs.taxonomy}=${a}`))},m=()=>{setTimeout(()=>{t.update()},200)},h=r=>{const t=e("#rl-folders-tree").jstree("get_selected",!1);let s;if(rlFoldersArgs.wholerow){const r=e("div.jstree-wholerow.jstree-wholerow-clicked");void 0!==r.droppable("instance")&&r.droppable("destroy"),s=e("#rl-folders-tree .jstree-wholerow:not(:eq(0))").not(`#${t} .jstree-wholerow-clicked`)}else{const r=e(`#${t}_anchor`);void 0!==r.droppable("instance")&&r.droppable("destroy"),s=e(`#rl-folders-tree li a.jstree-anchor:not(:eq(0),#${t}_anchor)`)}"list"===r?s.droppable({activeClass:"rl-folders-state-active",hoverClass:"rl-folders-state-hover",accept:"#the-list tr",tolerance:"pointer",drop:(r,t)=>{const l=e(r.target).closest("li").find("a.jstree-anchor"),s=e(`#${e("#rl-folders-tree").jstree().get_selected().toString()}_anchor`),o=[],a=e('#the-list .check-column input[type="checkbox"]:checked');let d=parseInt(s.data("term_id")),n=parseInt(l.data("term_id"));isNaN(d)&&(d=-1),isNaN(n)&&(n=-1),u(!0),0===a.length?o.push(t.draggable.find('.check-column input[type="checkbox"]').val()):a.each((r,t)=>{o.push(parseInt(e(t).val()))}),e.post(ajaxurl,{action:"rl-folders-move-attachments",attachment_ids:o,old_term_id:d,new_term_id:n,nonce:rlFoldersArgs.nonce}).done(r=>{try{if(r.success){if(-1!==d){for(let t=0;t<r.data.attachments.success.length;t++){const l=e(`#post-${r.data.attachments.success[t]}`);l.fadeOut("fast",()=>{l.remove(),0===e("#the-list tr").length&&e("#the-list").append(rlFoldersArgs.no_media_items)})}_(s,r.data,!1)}_(l,r.data,!0)}}catch(t){}u(!1)}).fail(()=>{u(!1)})}}):s.droppable({activeClass:"rl-folders-state-active",hoverClass:"rl-folders-state-hover",accept:"li.attachment",tolerance:"pointer",drop:(r,t)=>{const s=e(r.target).closest("li").find("a.jstree-anchor"),o=e(`#${e("#rl-folders-tree").jstree().get_selected().toString()}_anchor`),a=o.data("term_id"),d="all"===a?-1:parseInt(a),n=[];u(!0),e(".media-frame").hasClass("mode-edit")?n.push(parseInt(t.draggable.data("id"))):e("ul.attachments > li.selected").each((r,t)=>{n.push(parseInt(e(t).data("id")))}),e.post(ajaxurl,{action:"rl-folders-move-attachments",attachment_ids:n,old_term_id:d,new_term_id:parseInt(s.data("term_id")),nonce:rlFoldersArgs.nonce}).done(r=>{try{if(r.success){if(-1!==d){for(let t=0;t<r.data.attachments.success.length;t++){const l=e(`ul.attachments li[data-id="${r.data.attachments.success[t]}"]`);l.fadeOut("fast",()=>{l.remove(),0===e("ul.attachments li").length&&e(".no-media").removeClass("hidden")})}_(o,r.data,!1)}_(s,r.data,!0),l.controller.deactivateMode("select").activateMode("edit")}}catch(t){}u(!1)}).fail(()=>{u(!1)})}})},g=r=>{if("grid"===r){let r=0;e(".media-frame-content ul.attachments li").draggable({helper:()=>{let t=1;return t="grid"===s?e(".media-frame").hasClass("mode-edit")?1:e("ul.attachments li.selected").length:e('#the-list .check-column input[type="checkbox"]:checked').length,r=t,`<div class="rl-folders-dragged-item"><div class="dashicons dashicons-media-default"></div><span>${t}</span></div>`},drag:()=>{if(0===r)return!1},appendTo:"body",distance:3,cursor:"move",cursorAt:{top:20,left:20},containment:"#wpwrap",revert:"invalid",cancel:"input, label, a, .check-column, .column-primary a, .row-actions, .toggle-row",zIndex:999})}else e("#the-list tr").draggable({helper:()=>{let r=e('#the-list .check-column input[type="checkbox"]:checked').length;return 0===r&&(r=1),`<div class="rl-folders-dragged-item"><div class="dashicons dashicons-media-default"></div><span>${r}</span></div>`},appendTo:"body",distance:3,cursor:"move",cursorAt:{top:20,left:20},containment:"#wpwrap",revert:"invalid",cancel:"input, label, a, .check-column, .column-primary a, .row-actions, .toggle-row",zIndex:999})},_=(r,t,l)=>{const s=r.html().split(/(?:<i(?:.+)?\/i>)(.+)\s\((\d+)\)/);e("#rl-folders-tree").jstree("rename_node",r.parent().attr("id"),`${s[1]} (${parseInt(s[2])+(l?t.attachments.success.length-t.attachments.duplicated.length:-t.attachments.success.length)})`)},u=r=>{r?"list"===s?e(".filter-items .actions").find(".spinner").addClass("is-active"):e(".media-toolbar-secondary").find(".spinner").addClass("is-active"):"list"===s?e(".filter-items .actions").find(".spinner").removeClass("is-active"):e(".media-toolbar-secondary").find(".spinner").removeClass("is-active")},w=(r,t,l)=>{o=!0,e("#rl-folders-tree").jstree("move_node",r,t,l)},v=(r,t)=>{const l="#"+e("#rl-folders-tree").jstree().get_selected().toString(),o=e("#rl-folders-tree").jstree(!0).get_json("#",{flat:!0});if(e(r?".rl-folders-add-new-folder":".rl-folders-rename-folder").show(),e(r?".rl-folders-save-new-folder, .rl-folders-cancel-new-folder":".rl-folders-save-folder, .rl-folders-cancel-folder").hide(),e(r?".rl-folders-rename-folder, .rl-folders-delete-folder":".rl-folders-add-new-folder, .rl-folders-delete-folder").removeClass("disabled-link"),r&&t){const r=e("#rl-folders-tree").jstree("get_parent",l);e("#rl-folders-tree").jstree("delete_node",l),"list"===s&&(a=!0),e("#rl-folders-tree").jstree("select_node",r)}else e("#rl-folders-tree").jstree("is_leaf",l)||e(".rl-folders-expand-folder, .rl-folders-collapse-folder").removeClass("disabled-link"),e(l+"_span").remove(),e(l+"_anchor").show();e.each(o,(r,t)=>{e("#rl-folders-tree").jstree("enable_node",t.id)}),h(s),e(document).on("click",".jstree-anchor",y)},j=(r,t)=>{const l=e(r?"#rl-folders-enter-new-folder":"#rl-folders-enter-folder"),o=e("#rl-folders-tree").jstree().get_selected().toString(),a=l.val().trim(),c=l.data("nof");let f=0;if(r||(f=parseInt(l.data("term_id")),isNaN(f)&&(f=0)),""===a||a===l.attr("placeholder"))return v(r,!0),!1;u(!0),e.post(ajaxurl,r?{action:"rl-folders-add-term",parent_id:t,name:a,nonce:rlFoldersArgs.nonce}:{action:"rl-folders-rename-term",term_id:f,name:a,nonce:rlFoldersArgs.nonce}).done(t=>{try{t.success?(r?(e("#media-attachment-rl-folders-filters").append('<option value="'+t.data.term_id+'">'+t.data.name+"</option>"),null!==d&&(d.toolbar.get("RLfoldersAttachmentFilters").filters[t.data.term_id]={text:t.data.name,priority:n+1,props:{[rlFoldersArgs.taxonomy]:t.data.term_id,force_update:0,include_children:!1}})):(e('#media-attachment-rl-folders-filters option[value="'+f+'"]').text(t.data.name),e('#media-attachment-rl-folders-filters option[value="'+f+'"]').prop("selected",!0)),i={response:t.data,create:r},e("#rl-folders-tree").jstree("rename_node",o,t.data.name+" ("+c+")"),e("#rl-folders-tree").jstree("sort",o,!1),r&&(e("#"+o+"_anchor").attr("data-term_id",t.data.term_id).attr("href",t.data.url),e("#media-attachment-rl-folders-filters").val(t.data.term_id).trigger("change"),"list"===s&&window.location.replace(t.data.url)),b(e(t.data.select).find("option"),r?t.data.term_id:f)):v(r,!0),v(r,!1)}catch(l){v(r,!0)}u(!1)}).fail(()=>{u(!1),v(r,!0)})},b=(r,t)=>{e("#rl_folders_upload_files").empty().append(r).val(t)},y=r=>{e("#media-attachment-rl-folders-filters").val(e(r.currentTarget).data("term_id")).trigger("change")},x=(e,r)=>{const t=new RegExp("[?&]"+e.replace(/[\[\]]/g,"\\$&")+"(=([^&#]*)|&|#|$)").exec("&"+r);return t&&t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):""}})(jQuery);
