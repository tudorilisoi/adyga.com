(e=>{e(()=>{let l=null,s=null,d=null,o=e(".rl-gallery-images"),c=e(".rl-gallery-ids"),p=o.find('li[data-type="embed"]').length;const m={};let u=!1,g=null,h="",b=!1;const f=()=>{if(g){const e=parseInt(g.text());g.text(e+1)}},y=()=>{if(g){const e=parseInt(g.text());g.text(e-1)}};n(o,c,e('input[name="rl_gallery[images][menu_item]"]:checked').val()),t(),e(document).on("change",".rl-gallery-tab-menu-item",t=>{const a=e(t.currentTarget).closest(".postbox").attr("id").replace("responsive-gallery-",""),i=e(t.currentTarget).closest(".rl-gallery-tab-menu"),r=e(t.currentTarget).closest(".inside").find(".rl-gallery-tab-content"),s=i.find(".spinner"),d=e(t.currentTarget).val();r.addClass("rl-loading-content"),i.addClass("rl-loading-content"),s.fadeIn("fast").css("visibility","visible"),e.post(ajaxurl,{action:"rl-get-menu-content",post_id:rlArgsGalleries.postId,tab:a,menu_item:d,nonce:rlArgsGalleries.nonce}).done(t=>{try{t.success&&(r.html(t.data),r.removeClass("rl-loading-content"),i.removeClass("rl-loading-content"),l=null,o=e(".rl-gallery-images"),c=e(".rl-gallery-ids"),n(o,c,d),r.find(".color-picker").wpColorPicker())}catch(a){}}).always(()=>{s.fadeOut("fast")})}),e(document).on("click",".nav-tab",t=>{t.preventDefault();const a=e(t.currentTarget).attr("href").substr(1);e(".nav-tab").removeClass("nav-tab-active"),e(t.currentTarget).addClass("nav-tab-active"),e('#responsive_lightbox_metaboxes-sortables div[id^="responsive-gallery-"]').removeClass("rl-display-metabox").addClass("rl-hide-metabox"),""===a?e("#responsive-gallery-images").addClass("rl-display-metabox").removeClass("rl-hide-metabox"):e("#responsive-gallery-"+a).addClass("rl-display-metabox").removeClass("rl-hide-metabox"),e('input[name="rl_active_tab"]').val(a)}),e(".rl-shortcode").on("click",t=>{const a=e(t.currentTarget).data("number"),l=document.getElementsByClassName("rl-shortcode").item(a),i=window.getSelection();i.removeAllRanges();const r=document.createRange();r.selectNodeContents(l),i.addRange(r)}),e(document).on("click",".rl-gallery-image-remove",t=>{if(t.preventDefault(),1===e(t.currentTarget).closest(".rl-gallery-images-featured").length)return!1;const a=e(t.currentTarget).closest("li.rl-gallery-image");let l=r(c,!1);return l=_.without(l,a.data("attachment_id")),a.remove(),c.val(_.uniq(l).join(",")),!1}),e(document).on("click",".rl-gallery-image-edit",t=>{t.preventDefault();let a=e(t.currentTarget).closest("li.rl-gallery-image").data("attachment_id");const l=parseInt(a);return l==a?(a=l,null!==d&&(d.detach(),d.dispose(),d=null),d=wp.media({id:"rl-edit-attachment-modal",frame:"select",uploader:!1,title:rlArgsGalleries.editAttachment,library:{post__in:[a],type:rlArgsGalleries.supports.default,content:"browse",contentUserSetting:!1,router:"browse",searchable:!1,sortable:!1,multiple:!1,editable:!0},button:{text:rlArgsGalleries.saveChanges}}).on("open",()=>{const e=wp.media.attachment(a),t=d.state().get("selection");d.content.mode("browse"),d.$el.closest(".media-modal").addClass("rl-edit-modal"),d.$el.closest(".media-frame").addClass("hide-router"),e.fetch(),t.add(e)}).on("close",()=>{d.state().get("selection").reset()}),d.open()):/^e\d+$/.test(a)&&(null!==d&&(d.detach(),d.dispose(),d=null),d=wp.media({id:"rl-edit-attachment-modal",frame:"select",uploader:!1,title:rlArgsGalleries.editEmbed,library:{post__in:[0]},button:{text:rlArgsGalleries.saveChanges}}).on("open",()=>{const t=wp.media.attachment(a),l=d.state().get("selection"),i=e(`.rl-gallery-image[data-attachment_id="${a}"]`);d.content.mode("browse"),d.$el.closest(".media-modal").addClass("rl-edit-modal"),d.$el.closest(".media-frame").addClass("hide-router"),t.fetch(),t.id=a,t.attributes={id:a,filename:i.find('input[data-type="url"]').val(),dateFormatted:i.find('input[data-type="date"]').val(),width:i.find('input[data-type="width"]').val(),height:i.find('input[data-type="height"]').val(),title:i.find('input[data-type="title"]').val(),description:i.find('textarea[data-type="caption"]').val(),url:i.find('input[data-type="url"]').val(),sizes:{thumbnail:{width:i.find('input[data-type="thumbnail_width"]').val(),height:i.find('input[data-type="thumbnail_height"]').val(),url:i.find('input[data-type="thumbnail_url"]').val(),orientation:"landscape"}},type:"image"},l.add(t),d.$el.find(".media-sidebar h2").text(rlArgsGalleries.videoDetails);const r=d.$el.find(".attachment-details");r.find("p.description").hide(),r.find('[data-setting="alt"]').hide(),r.find('[data-setting="caption"]').hide(),r.find('[data-setting="title"] input').prop("readonly",!1),r.find('[data-setting="description"] textarea').prop("readonly",!1);d.toolbar.get().primary.$el.find("button").on("click",()=>{i.find('input[data-type="title"]').val(r.find('[data-setting="title"] input').val()),i.find('textarea[data-type="caption"]').val(r.find('[data-setting="description"] textarea').val())})}),d.open()),!1}),e(document).on("click",".rl-gallery-image-status",t=>{t.preventDefault();const a=e(t.currentTarget).closest("li.rl-gallery-image");return a.hasClass("rl-status-active")?(a.addClass("rl-status-inactive").removeClass("rl-status-active"),a.find(".rl-gallery-exclude").val(a.data("attachment_id"))):(a.addClass("rl-status-active").removeClass("rl-status-inactive"),a.find(".rl-gallery-exclude").val("")),!1}),e(document).on("click",".rl-gallery-select:not(.button-disabled)",t=>{t.preventDefault(),null===l?(l=wp.media({title:rlArgsGalleries.textSelectImages,multiple:"add",autoSelect:!0,filters:"all",library:{type:rlArgsGalleries.supports.default,filters:"all"},button:{text:rlArgsGalleries.textUseImages}}).on("content:render",t=>{if(null!==t){const a=t.toolbar.secondary.$el.find("select.attachment-filters");if(a.length>1){const t=parseInt(100/a.length)-2;e(a).each((a,l)=>{e(l).css("width",`calc(${t}% - 12px)`)})}}}).on("open",()=>{const t=l.toolbar.get();t.set("rl-clear-selection",{style:"secondary",priority:0,text:rlArgsGalleries.clearSelection,requires:{selection:!0},click(){this.controller.state().get("selection").reset(),t.secondary.$el.find(".rl-gallery-count").text(0)}});const a=l.state().get("selection"),i=r(c,!0);u?t.secondary.$el.find(".rl-gallery-count").text(i.length):(t.secondary.$el.append(`<div class="media-selection"><div class="selection-info"><span class="count">${rlArgsGalleries.selectedImages}: <span class="rl-gallery-count">${i.length}</span></span></div></div>`),u=!0),a.reset(),e.each(i,(e,t)=>{attachment=wp.media.attachment(t),a.off("add",f),a.off("remove",y),a.add(attachment?[attachment]:[])});const n=t.secondary.$el.find(".rl-gallery-count");g=n,a.on("add",f).on("remove",y)}).on("select",()=>{const t=l.state().get("selection");let a=r(c,!1);const n=[];t&&t.map(t=>{if("number"==typeof t.id){if(n.push(t.id),-1!==e.inArray(t.id,a))return;a.push(t.id);const l={width:150,height:150,orientation:"landscape",url:(t=t.toJSON()).url};"image"===t.type?t.sizes&&t.sizes.thumbnail&&(t.sizes.thumbnail.url&&(l.url=t.sizes.thumbnail.url),t.sizes.thumbnail.height&&(l.height=t.sizes.thumbnail.height),t.sizes.thumbnail.width&&(l.width=t.sizes.thumbnail.width),t.sizes.thumbnail.orientation&&(l.orientation=t.sizes.thumbnail.orientation)):"video"===t.type&&(l.url=rlArgsGalleries.videoIcon,t.thumb?(t.thumb.src&&t.icon!==t.thumb.src&&(l.url=t.thumb.src),t.thumb.height&&(l.height=t.thumb.height),t.thumb.width&&(l.width=t.thumb.width),t.thumb.orientation&&(l.orientation=t.thumb.orientation)):t.image&&(t.image.src&&t.icon!==t.image.src&&(l.url=t.image.src),t.image.height&&(l.height=t.image.height),t.image.width&&(l.width=t.image.width),t.image.orientation&&(l.orientation=t.image.orientation))),o.append(rlArgsGalleries.mediaItemTemplate.replace(/__MEDIA_ID__/g,t.id).replace(/__MEDIA_DATA__/g,`${i(o)}<img width="${l.width}" height="${l.height}" src="${rlArgsGalleries.thumbnail[0]}" class="attachment-thumbnail size-thumbnail format-${l.orientation}" alt="" />`).replace(/__MEDIA_STATUS__/g," rl-status-active").replace(/__MEDIA_TYPE__/g,t.type)),e(`li[data-attachment_id="${t.id}"]`).find("img").attr("alt",t.alt).attr("src",l.url)}else{if(n.push(+t.id),-1!==e.inArray(+t.id,a))return;a.push(+t.id)}});let s=a;for(let l=0;l<a.length;l++)if(-1===e.inArray(a[l],n)){if(/^e\d+$/.test(a[l]))continue;o.find(`li.rl-gallery-image[data-attachment_id="${a[l]}"]`).remove(),s=_.without(s,a[l])}c.val(_.uniq(s).join(","))}),l.open()):l.open()});const v=wp.media.view.Toolbar.Embed;wp.media.view.Toolbar.Embed=wp.media.view.Toolbar.Embed.extend({initialize(...e){this.options.text=rlArgsGalleries.embedVideo,v.prototype.initialize.apply(this,e)}});const w=wp.media.view.EmbedLink;wp.media.view.EmbedLink=wp.media.view.EmbedLink.extend({rlVideoFrameToolbar:null,rlDisableButton(){this.rlVideoFrameToolbar.primary.$el.find("button").prop("disabled",!0)},updateoEmbed(e,t,...a){const l=new RegExp("https?://((m|www).)?youtube.com/watch.*","i"),i=new RegExp("https?://(.+.)?vimeo.com/.*","i");rlArgsGalleries.supports.youtube&&l.test(t)||rlArgsGalleries.supports.vimeo&&i.test(t)?this.$el.find(".rl-embed-video-text").hide():(e.set("url",""),this.$el.find(".rl-embed-video-text").show()),w.prototype.updateoEmbed.apply(this,[e,t,...a])},fetch(...e){this.controller.state().props.get("url")&&(w.prototype.fetch.apply(this,e),this.dfd.done((e,t,a)=>{s.rlOembedResponse=e,this.rlVideoFrameToolbar.primary.$el.find("button").prop("disabled",!1)}))},initialize(...e){this.rlVideoFrameToolbar=s.toolbar.get(),w.prototype.initialize.apply(this,e),this.listenTo(this.model,"change:url",this.rlDisableButton)}}),e(document).on("click",".rl-gallery-select-videos:not(.button-disabled)",t=>{t.preventDefault(),null===s?(s=wp.media({frame:"post",state:"embed",type:"link",metadata:{}}).on("open",()=>{s.rlOembedResponse={};const t=s.content.get();t.$(".setting").hide();const a=[];rlArgsGalleries.supports.youtube&&a.push("YouTube"),rlArgsGalleries.supports.vimeo&&a.push("Vimeo"),0===t.$(".embed-link-settings").find(".rl-embed-video-text").length&&t.$(".embed-link-settings").prepend(`<span class="rl-embed-video-text">${rlArgsGalleries.onlyEmbedProviders.replace("%s",a.join(", "))}</span>`);const l=s.$el;l.length>0&&e(l).addClass("hide-menu");s.toolbar.get().primary.$el.find("button").prop("disabled",!0)}).on("close",()=>{const e=s.state();s.rlSelectedUrl=e.props.get("url"),e.props.set("url","http://")}).on("select",()=>{const t=r(c,!1),a=`e${p}`;t.push(a),c.val(_.uniq(t).join(","));const l=e(rlArgsGalleries.mediaEmbedTemplate.replace(/__EMBED_ID__/g,a));l.find('input[data-type="url"]').val(s.rlSelectedUrl),"width"in s.rlOembedResponse?l.find('input[data-type="width"]').val(s.rlOembedResponse.width):l.find('input[data-type="width"]').val(0),"height"in s.rlOembedResponse?l.find('input[data-type="height"]').val(s.rlOembedResponse.height):l.find('input[data-type="height"]').val(0),"thumbnail_url"in s.rlOembedResponse?l.find('input[data-type="thumbnail_url"]').val(s.rlOembedResponse.thumbnail_url):l.find('input[data-type="thumbnail_url"]').val(""),"thumbnail_width"in s.rlOembedResponse?l.find('input[data-type="thumbnail_width"]').val(s.rlOembedResponse.thumbnail_width):l.find('input[data-type="thumbnail_width"]').val(0),"thumbnail_height"in s.rlOembedResponse?l.find('input[data-type="thumbnail_height"]').val(s.rlOembedResponse.thumbnail_height):l.find('input[data-type="thumbnail_height"]').val(0),"title"in s.rlOembedResponse?l.find('input[data-type="title"]').val(s.rlOembedResponse.title):l.find('input[data-type="title"]').val(""),"description"in s.rlOembedResponse?l.find('textarea[data-type="caption"]').text(s.rlOembedResponse.description):l.find('textarea[data-type="caption"]').text(""),"upload_date"in s.rlOembedResponse?l.find('input[data-type="date"]').val(s.rlOembedResponse.upload_date):l.find('input[data-type="date"]').val(""),o.append(rlArgsGalleries.mediaItemTemplate.replace(/__MEDIA_ID__/g,a).replace(/__MEDIA_DATA__/g,`${i(o)}${l.html()}<img width="${s.rlOembedResponse.thumbnail_width}" height="${s.rlOembedResponse.thumbnail_height}" src="${s.rlOembedResponse.thumbnail_url}" class="attachment-thumbnail size-thumbnail format-${s.rlOembedResponse.thumbnail_width>s.rlOembedResponse.thumbnail_height?"landscape":"portrait"}" alt="" />`).replace(/__MEDIA_STATUS__/g," rl-status-active").replace(/__MEDIA_TYPE__/g,"embed")),p++}),s.open()):s.open()}),e(document).on("click",".rl-gallery-update-preview, .rl-gallery-preview-pagination a",t=>{t.preventDefault();const a=e(t.currentTarget),l=a.hasClass("rl-gallery-update-preview")?"update":"page",i=e(".rl-gallery-tab-menu-images input:checked").val(),r=e(`.rl-gallery-tab-inside-images-${i}`),n=a.closest("td").find(".rl-gallery-preview-inside .spinner"),s=e(t.currentTarget).closest(".inside").find(".rl-gallery-tab-content"),d=s.find('tr[data-field_type="media_preview"]'),o={};if(s.addClass("rl-loading-content"),d.find(".rl-gallery-content").removeClass("rl-content-disabled"),d.find(".rl-gallery-preview-pagination").removeClass("rl-content-disabled"),"page"===l){const e=a.attr("href").match("preview_page/\\d+");let t=1;null!==e&&(t=e[0].split("/")[1]),o.preview_page=t}else o.preview_page=1;return r.find("tr[data-field_type]").each((t,a)=>{const l=e(a),i=l.data("field_name");let r=null;switch(l.data("field_type")){case"text":r=l.find("input").val(),r||(r="");break;case"number":r=parseInt(l.find("input").val()),r||(r=0);break;case"taxonomy":r={id:parseInt(l.find("select option:selected").val()),children:l.find('input[type="checkbox"]').prop("checked")},r||(r={id:0,children:!1});break;case"select":r=l.find("select option:selected").val(),r||(r="");break;case"radio":r=l.find("input:checked").val(),r||(r="");break;case"multiselect":r=l.find("select").val(),r||(r=[]);break;case"hidden":const t=l.find('span[class="rl-response-data"]'),a=o.preview_page;r={},t.length>0&&t.each((t,l)=>{const i=e(l),n=i.data("provider"),s=i.data("name"),d=i.data("value");n in r||(r[n]={}),n in m||(m[n]={}),a in m[n]||(m[n][a]={}),m[n][a][s]=d,r[n][s]=d})}o[i]=r}),n.fadeIn("fast").css("visibility","visible"),e.post(ajaxurl,{action:"rl-get-preview-content",post_id:rlArgsGalleries.postId,menu_item:i,query:o,preview_type:l,excluded:e(".rl-gallery-exclude").map((t,a)=>e(a).val()).get(),nonce:rlArgsGalleries.nonce}).done(t=>{t.success&&(r.find("tr[data-field_type]").each((a,l)=>{const i=e(l);if("hidden"===i.data("field_type")&&"response_data"===i.data("field_name")){const a=t.data.response_data;for(const t in a)if(a.hasOwnProperty(t)){const l=a[t];for(const a in l)l.hasOwnProperty(a)&&e(`#rl_images_remote_library_response_data_${t}_${a}`).data("value",l[a])}}}),e(".rl-gallery-images").empty().append(t.data.images),e(".rl-gallery-preview-pagination").replaceWith(t.data.pagination))}).always(()=>{n.fadeOut("fast"),s.removeClass("rl-loading-content"),d.find(".rl-gallery-content").removeClass("rl-content-disabled"),d.find(".rl-gallery-preview-pagination").removeClass("rl-content-disabled")}),!1}),e(document).on("keyup","#rl-images-featured-number_of_posts, #rl-images-featured-offset, #rl-images-featured-images_per_post",t=>{a(e(t.currentTarget))}),e(document).on("keyup","#rl-images-remote_library-media_search",t=>{if("Enter"===t.key){t.preventDefault();const a=e(t.currentTarget),l=a.val();h=l,b=!0,a.closest(".inside").find(".rl-gallery-update-preview").trigger("click")}}),e(document).on("change",'#rl-images-remote_library-media_provider, #rl-images-folders-folder, #rl-images-folders-folder-include-children, #rl-images-featured-orderby, input[name="rl_gallery[images][featured][order]"], input[name="rl_gallery[images][featured][image_source]"], #rl-images-featured-post_type, #rl-images-featured-post_status, #rl-images-featured-post_format, #rl-images-featured-post_term, #rl-images-featured-post_author, #rl-images-featured-page_parent, #rl-images-featured-page_template, #rl-images-featured-number_of_posts, #rl-images-featured-offset, #rl-images-featured-images_per_post',t=>{const l=e(t.currentTarget);a(l),l.is("#rl-images-folders-folder, #rl-images-folders-folder-include-children, #rl-images-remote_library-media_provider")&&l.closest(".inside").find(".rl-gallery-update-preview").trigger("click")}),e(document).on("keypress","#rl-images-remote_library-media_search",e=>{"Enter"===e.key&&e.preventDefault()}),e(document).on("blur","#rl-images-remote_library-media_search",t=>{const a=e(t.currentTarget),l=a.val();b&&l===h?b=!1:(h=l,b=!1,a.closest(".inside").find(".rl-gallery-update-preview").trigger("click"))})}),e(document).on("change","#postimagediv .inside",t=>{const a=e(t.currentTarget).find('input[name="rl_gallery_featured_image"]:checked'),l=e(a).val();if(e("#postimagediv .inside").attr("data-featured-type",l),e(".rl-gallery-featured-image-select").children("div").hide(),e(`.rl-gallery-featured-image-select-${l}`).show(),"id"===l){const t=parseInt(e("#_thumbnail_id").attr("data-featured-id"));t>0&&e("#_thumbnail_id").val(t).attr("data-featured-id",-1)}else{const t=parseInt(e("#_thumbnail_id").val());t>0&&e("#_thumbnail_id").attr("data-featured-id",t).val(-1)}}),e(document).on("ajaxComplete",()=>{l()});const t=()=>{l(),e(".rl-gallery-tab-content .color-picker").wpColorPicker(),e("form#post").attr("novalidate","novalidate"),e("#responsive-gallery-images").show();const t=document.getElementById("responsive_lightbox_metaboxes-sortables");if(null!==t&&"undefined"!=typeof MutationObserver){const a=()=>{e(`#${e(".meta-box-sortables:visible:first").attr("id")}`).find(".postbox:visible:first .handle-order-higher").attr("aria-disabled","true")},l=new MutationObserver(t=>{_.each(t,t=>{if("class"===t.attributeName){const i=e(t.target);i.hasClass("ui-sortable")&&!i.hasClass("ui-sortable-disabled")&&setTimeout(()=>{i.sortable("disable"),i.sortable("destroy"),i.removeClass(),a();const t=e(".meta-box-sortables"),r=t.sortable("instance").options.stop;let n=!0;t.sortable({stop:()=>{n&&(n=!1,r()),n=!0,a()}}),e(document).on("postbox-toggled",a),e(".postbox .handle-order-higher, .postbox .handle-order-lower").on("click.postboxes",a),l.disconnect()},50)}})});l.observe(t,{attributes:!0})}},a=e=>{const t=e.closest("table").find('tr[data-field_type="media_preview"]');t.find(".rl-gallery-content").addClass("rl-content-disabled"),t.find(".rl-gallery-preview-pagination").addClass("rl-content-disabled")},l=()=>{e(".rl-gallery-tab-inside select.select2").select2({closeOnSelect:!0,multiple:!0,width:300,minimumInputLength:0})},i=t=>{const a=e('input[name="rl_active_tab"]').val(),l=e(`.rl-gallery-tab-menu-${a}`).find(".rl-gallery-tab-menu-item:checked").val(),i=t.closest("tr[data-field_name]").data("field_name");return rlArgsGalleries.mediaExcludeTemplate.replace(/__MEDIA_TAB_ID__/g,a).replace(/__MEDIA_MENU_ITEM__/g,l).replace(/__MEDIA_FIELD_NAME__/g,i)},r=(e,t)=>{const a=e.val(),l=[];return""!==a&&a.split(",").forEach((e,a)=>{const i=parseInt(e);t?Number.isInteger(i)&&i>0&&l.push(i):i==e?l.push(i):/^e\d+$/.test(e)&&l.push(e)}),l},n=(t,a,l)=>{"media"===l&&t.sortable({items:"li.rl-gallery-image",cursor:"move",scrollSensitivity:40,forcePlaceholderSize:!0,forceHelperSize:!1,helper:"clone",opacity:.65,placeholder:"rl-gallery-sortable-placeholder",start:(e,t)=>{t.item.css("border-color","#f6f6f6")},stop:(e,t)=>{t.item.removeAttr("style")},update:(l,i)=>{const r=[];t.find("li.rl-gallery-image").each((t,a)=>{r.push(e(a).attr("data-attachment_id"))}),a.val(_.uniq(r).join(","))}})}})(jQuery);
