server {
    # Hide nginx version
    server_tokens off;
    more_clear_headers Server;
    # File upload size limits
    client_max_body_size 100M;
    client_body_timeout 120s;
    client_header_timeout 120s;

    listen 80;
    server_name localhost;

    root /var/www/html;
    index index.php;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Default request handling
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # Block access to sensitive files
    location ~* ^/(wp-config.php|xmlrpc.php|wp-cron.php|((readme|license)\.(txt|html|md))) {
        deny all;
    }

    # PHP handling
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_read_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_connect_timeout 300s;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        # Security: hide PHP version
        fastcgi_hide_header X-Powered-By;
        fastcgi_hide_header WPO-Cache-Status;
        fastcgi_hide_header WPO-Cache-Message;
    }

    # --- Security Hardening ---

    # Block PHP in uploads (prevents webshells)
    location ~* /wp-content/uploads/.*\.php$ {
        deny all;
    }

    # Block PHP in wp-includes (except needed scripts)
    location ~* /wp-includes/.*\.php$ {
        deny all;
    }

    # Allow only admin-ajax.php for AJAX calls
    location = /wp-admin/admin-ajax.php {
        include fastcgi_params;
        fastcgi_pass wordpress:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
         # Security: hide PHP version
        fastcgi_hide_header X-Powered-By;
    }

    location ~ /\. {
        deny all;
    }

    #GZIP
    # Enable gzip compression.
    gzip on;

    # Compression level (1-9).
    # 5 is a perfect compromise between size and CPU usage, offering about
    # 75% reduction for most ASCII files (almost identical to level 9).
    gzip_comp_level 5;

    # Don't compress anything that's already small and unlikely to shrink much
    # if at all (the default is 20 bytes, which is bad as that usually leads to
    # larger files after gzipping).
    gzip_min_length 256;

    # Compress data even for clients that are connecting to us via proxies,
    # identified by the "Via" header (required for CloudFront).
    gzip_proxied any;

    # Tell proxies to cache both the gzipped and regular version of a resource
    # whenever the client's Accept-Encoding capabilities header varies;
    # Avoids the issue where a non-gzip capable client (which is extremely rare
    # today) would display gibberish if their proxy gave them the gzipped version.
    gzip_vary on;

    # Compress all output labeled with one of the following MIME-types.
    gzip_types
    application/atom+xml
    application/javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rss+xml
    application/vnd.geo+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    font/opentype
    image/bmp
    image/svg+xml
    image/x-icon
    text/cache-manifest
    text/css
    text/plain
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy;
    # text/html is always compressed by gzip module
    

    # Optional: cache static files aggressively
    # location ~* \.(js|css|png|jpg|jpeg|gif|ico|pdf|webp|svg)$ {
    #     expires max;
    #     access_log off;
    #     log_not_found off;
    # }
}
